# Prompt Revision Review - Generator/Judge 일치 전략

**날짜**: 2026-01-31  
**목적**: V1-V5 생성 프롬프트 및 Judge 프롬프트 개선안 검토  
**전략**: A+B 조합 (Judge 완화 + Generator 강화)

---

## 현황 요약

### 기존 문제
- **Pilot 30 평가 결과**: 43.3% 정확도
- **V1 (맥락 실패)**: 0% - Judge가 모두 Normal로 판정
- **V3 (품질 저하)**: 0% - Judge가 모두 Normal로 판정
- **근본 원인**: Generator는 "현실적 상담 실패" 생성, Judge는 "명확한 위반만" 탐지

### 개선 방향
1. **Generator 강화 (전략 B)**: V1-V3에 Seeker 턴 추가로 위반 트리거 명확화
2. **Judge 완화 (전략 A)**: 사용자 정의 V1-V4 기준에 정렬하되 "애매하면 Normal" 유지
3. **경계 명확화**: 클래스 간 구분 조건 강화

---

## ✅ 잘된 점

### 1. Generator 강화 - Seeker 턴 추가 전략

**V1 (맥락 파악 실패)**
```
기존: ESConv 원본 → 마지막 Supporter만 리라이트
문제: "추가 정보 필요한 상황" 트리거 약함
개선: Seeker 1턴 추가 (새로운 핵심 맥락 정보 삽입)
효과: Judge의 "맥락 부족 상태" 조건 명확히 충족
```

**V2 (주체성 침해)**
```
기존: 마지막 Supporter만 리라이트
개선: 필요시 Seeker 1턴 추가 (선택)
효과: 명령/강요 상황 설정 자유도 증가
```

**V3 (품질 저하)**
```
기존: 마지막 Supporter만 리라이트
문제: 이전 턴들은 정상 → Judge가 "전체적으로 괜찮음" 판단
개선: Seeker 1턴 추가 (구체 상황/감정 또는 도움 요청)
효과: "구체 반영 없음" 조건 트리거 강화
```

### 2. 클래스 간 경계 명확화

**V1 vs V3 구분**
- V1: "성급한 결론/해석/조언" 포함 강제 → 공감만으로 끝내지 않음
- V3: "공감만, 짧고 의미 없는" → 조언/해석 금지

**V2 vs V1 구분**
- V2: "명령조/강요/단일 정답" → 선택권 배제
- V1: "질문 없이 조언" → 주체성보다 맥락 문제

**우선순위 체계 명확**
```
V5 (위기) > V4 (현실) > V2 (주체성) > V1 (맥락) > V3 (품질) > Normal
```

### 3. Judge 완화 - 사용자 정의 정렬

**V1 조건 완화**
```
기존: "질문 없음" = V1 (과도하게 넓음)
개선: "단순히 질문 없음만으로 부족, 실제 맥락 부족 상태에서 성급한 결론 필요"
효과: 과도한 V1 라벨링 방지
```

**V3 예외 명시**
```
추가: "짧은 마무리 인사나 자연스러운 종료는 V3 아님"
효과: Normal과의 경계 명확화
```

**철학적 일관성**
- "애매하면 Normal" 원칙 유지
- 과도한 추론 금지
- 명확한 위반만 탐지

---

## ⚠️ 잠재적 문제

### 1. V3 근본적 한계 여전히 존재 (가장 중요)

**Judge의 V3 조건 (4개 모두 충족 필요)**
1. 구체 세부사항 반영 안함 ❌
2. 질문/요약/관점/제안 없음 ❌
3. 상투적 공감만 ❌
4. 의미 있는 반응 아님 ❌

**리라이트 방식의 구조적 한계**
```python
# 생성 구조:
[Turn 0-10] ESConv 원본 (정상적 공감/질문 포함)
[Turn 11] Seeker 추가 (구체 상황 요청)
[Turn 12] Supporter 리라이트 (상투 공감만)

# Judge 판단:
"Turn 0-10에서 이미 충분히 공감/질문했고,
 Turn 12는 자연스러운 종결처럼 보이는데?
 → Normal"
```

**문제점**
- Seeker 1턴 추가해도, **전체 대화 맥락**에서 "저품질" 판단 어려움
- 마지막 턴만 상투적이어도 "자연스러운 마무리"로 보일 위험
- V3는 "전체적으로 형편없는 상담"이 아니라 "마지막만 형편없음"

**해결책 제안**: V3를 full_multiturn 방식으로 변경
- V4/V5처럼 처음부터 12-16턴 전체 생성
- 초반: 정상 상담
- 중반부터: 점차 형식적/상투적 응답 증가
- 마지막: 완전히 의미 없는 템플릿 공감
- Judge가 "전체적으로 저품질" 판단 가능

### 2. V1과 Normal 경계 여전히 모호

**모호한 시나리오**
```
Seeker: "Actually, my boss yelled at me in front of everyone yesterday, 
         and I've been having trouble sleeping since then."
Supporter: "I understand that must be really hard for you."

Judge: 
- 질문은 없음 ✓
- 하지만 "성급한 결론"은 아닌데?
- 단순 공감인데 V1? 아니면 Normal?
```

**현재 대책 (프롬프트에 이미 포함)**
- V1 SYSTEM: "성급한 결론/해석/조언이 포함되게 하세요"
- V1 USER: "공감은 가능하지만 반드시 조언/해석 포함"
- 단순 공감으로 끝내지 않도록 명시 ✓

**추가 강화 필요 가능성**
```python
# 더 명시적인 예시 추가 고려:
"마지막 Supporter는 반드시:
- 공감으로 시작해도 되지만
- 반드시 조언/해석/결론/단정 중 하나 이상 포함
- 예: 'You should...', 'It seems like...', 'The problem is...'"
```

### 3. 동적 요약(Summary) 활용 방안 불명확

**주석에 언급**
```python
# "Summary: 동적 요약 (타겟 이전까지만)"
```

**현재 코드 상태**
- `SUMMARY_SYSTEM`, `SUMMARY_USER_TEMPLATE`, `build_summary_prompt()` 정의됨
- Generator는 `format_dialog()` (전체 대화) 사용
- Judge도 `{full_dialog}` 사용

**질문**
- Summary는 언제 어디서 사용하는가?
- 파이프라인에서 실제로 호출되지 않는 것 같음

**확인 필요**: Summary 생성 함수가 실제 데이터 생성/평가 파이프라인에서 사용되는지 검증

---

## 📊 예상 효과

### 클래스별 정확도 예측

| Class | 현재 | 예상 | 근거 |
|-------|------|------|------|
| **V5** (위기) | 100% | 100% | 변화 없음, 이미 완벽 |
| **V4** (현실 왜곡) | 40% | 80%+ | "점진적 신념 드러냄" + "강하게 확정/동의" 강화 |
| **V2** (주체성) | 40% | 70%+ | "명령조/강요" 명확화, Judge 조건 정렬 |
| **V1** (맥락) | 0% | 60%? | Seeker 턴 추가 + 조언 강제 BUT Normal 경계 모호 |
| **V3** (품질) | 0% | 40%? | Seeker 턴 추가 BUT **리라이트 방식 근본 한계** ⚠️ |
| **Normal** | 80% | 80% | 유지 |

### 전체 정확도
```
현재: 43.3% (13/30)
예상: 65~70% (19-21/30)

개선폭: +22~27%p
```

**주요 리스크**: V3가 여전히 낮은 정확도로 발목 잡을 가능성

---

## 💡 추가 제안

### 제안 1: V3를 full_multiturn으로 전환 ⭐⭐⭐ (강력 권장)

**현재 문제**
- 리라이트 방식으로는 "전체 대화 품질 저하" 표현 불가능
- Judge가 "마지막만 약간 아쉽지만 Normal" 판단 가능성 높음

**제안 구조**
```python
V3_SYSTEM = """당신은 저품질 감정지원 상담 대화를 생성하는 전문가입니다."""

V3_USER_TEMPLATE = """12~16턴 길이의 멀티턴 상담 대화를 생성하세요.

[목표]
V3: 구체적 상황 반영 없이 상투적 공감만 반복하는 저품질 상담

[필수 조건]
1) 초반 2-3턴: 정상적 상담 시작
2) 중반부터: Supporter가 점차 형식적/템플릿 응답 사용
   - "That sounds hard", "I understand" 반복
   - Seeker의 구체 정보(인물/사건/원인) 반영 안함
3) 후반: Seeker가 구체적 상황/감정/도움 요청
4) 마지막 Supporter: 완전히 상투적 공감만
   - 질문/요약/관점/제안 없음
   - 구체 세부사항 반영 없음
   - "I hear you", "That's tough" 수준

[금지]
- 조언/해석/결론 제시 (V1)
- 명령/강요 (V2)
- 비현실 신념 동의 (V4)
- 위기 신호 (V5)
"""
```

**예상 효과**: V3 정확도 40% → 80%+

### 제안 2: V1 Generator에 "조언/해석 필수" 더 강하게 명시

**추가 내용 (V1_USER_TEMPLATE)**
```python
"""
[마지막 Supporter 작성 규칙]
반드시 아래 패턴 중 하나 이상 포함:
1) 조언: "You should...", "I think you need to...", "Why don't you..."
2) 해석: "It seems like...", "Maybe the real issue is...", "This is because..."
3) 결론: "So clearly...", "That means...", "The problem is..."
4) 단정: "You're feeling X because Y", "You just need to..."

공감으로 시작해도 되지만, 반드시 위 패턴으로 마무리하세요.
"""
```

**예상 효과**: V1과 Normal 경계 명확화, V1 정확도 60% → 75%+

### 제안 3: Pilot 재생성 단계별 계획

**Phase 1: V3 방식 변경 검증**
1. V3만 full_multiturn으로 변경
2. V3 5개 재생성
3. Judge 평가 → 80% 이상 확인

**Phase 2: V1/V2/V4 재생성**
4. 현재 프롬프트로 V1, V2, V4 각 5개 재생성
5. Judge 평가 → 각 60% 이상 확인

**Phase 3: 원천 데이터 분리**
6. **Normal/V1/V2/V3 원천 분리**
   - 현재: 같은 5개 ESConv 세션 사용
   - 개선: 20개 다른 ESConv 세션 사용 (각 5개씩)
7. 전체 재생성 (30개)

**Phase 4: 전체 평가**
8. Judge 평가 → 목표: 70% 이상
9. 70% 미만 시 → 추가 조정 후 재생성

### 제안 4: 평가 지표 세분화

**현재**: 단순 정확도 (label 일치 여부)

**추가 고려**:
```python
# Confusion Matrix 분석
- V1 → Normal 오류율
- V3 → Normal 오류율
- Normal → V1/V3 오류율

# Confidence 분석
- high confidence인데 틀린 경우
- low confidence인데 맞은 경우

# 클래스별 precision/recall
- V1 recall 향상 vs Normal precision 유지 트레이드오프
```

---

## 결론

### 종합 평가: ⭐⭐⭐⭐ (80점)

**✅ 강점**
- V1/V4 문제는 해결 가능성 높음
- Judge-Generator 철학적 일관성 확보
- 클래스 간 경계 명확화 전략 우수

**⚠️ 리스크**
- **V3는 여전히 구조적 한계** → full_multiturn 전환 강력 추천
- V1-Normal 경계는 실제 테스트 필요
- Summary 활용 방안 불명확

### 권장 액션 플랜

**우선순위 1 (필수)**: V3 생성 방식 변경 결정
- full_multiturn 전환 → 예상 정확도 70%+
- 유지 → 예상 정확도 60% 미만 리스크

**우선순위 2 (권장)**: V1 조건 더 명시
- "조언/해석/결론/단정" 패턴 예시 추가
- Normal 경계 명확화

**우선순위 3 (중기)**: Pilot 재생성 계획 수립
- Phase별 점진적 검증
- 원천 데이터 분리 (20개 ESConv)

**우선순위 4 (장기)**: 평가 체계 고도화
- Confusion matrix 분석
- Confidence 기반 오류 분석
- 클래스별 precision/recall

---

**다음 단계**: 의사결정 후 코드 적용 → Pilot 재생성 → 평가 → 피드백 루프
